# API для проведения опросов.

#### Базовая документация к проекту

Основные системные требования:
* Разработано на python 3.9 
* Зависимости (Python) из requirements.txt

### Установка необходимого ПО

```
pip install -r requirements.txt
``` 
#### Возможно запустить файл run.bat - В результате будут проделаны все действия, указанные ниже и база данных будет наполнена тестовыми данными.
```
папка проекта/run.bat
```
#### Создание миграция, применение миграция и старт сервера. Внимание, в этом случае база данных будет пустая.
```
python manage.py makemigrations
python manage.py migrate
python manage.py runserver
```

#### Заполняет базу данных тестовыми данными (не обязательно).
```
python manage.py fill_db
```
#### Удаляет базу данных и очищает миграции
```
python manage.py clear_and_migrate
```
После успешного запуска сервера возможно использовать API. Его описание ниже.

___
## Описание работы API:
___
### Пользователи:
#### Регистрация для пользователя:
Ссылка: ```/api/users/register/```
Метод:``` post ```
На вход принимает json вида:
```json
{"user": {
    "username": "str",
    "password": "str",
    "email": "str" }}
```
При успешном создании пользователя вернется статус 201_Created и все данные пользователя.

#### Авторизация для пользователя:
Ссылка: ```/api/users/login/```
Метод: ```post```
На вход принимает json вида:
```json
{"user": {
    "username": "str",
    "password": "str"
}}
```
При успешной авторизации пользователя вернется статус 200_OK и json вида:
```json
{"user": {
    "username": "str",
    "token": "str"
}}
```
Дальнейшая авторизация при работе с API для авторизированного пользователя будет
осуществляться при передаче token в headers в следующем виде:
```json
{"Authorization": "Token USER_TOKEN"}
```
#### Изменение данных пользователя:
Ссылка: ```/api/users/update/```
Метод: ```patch```
На вход принимает dict вида:
```json
{"user": {
    "email": "str",
    "first_name": "str",
    "last_name": "str",
    "username": "str",
    "password": "str"
}}
```
Возможно частичное изменение значений полей, передавать ВСЕ данные для изменения одного поля не нужно.
При успешном изменении пользователя вернется статус 200_OK и json с измененными данными.

#### Получение данных пользователя:
Ссылка: ```/api/users/user/```
Метод: ```get```
Возвращает json со всеми данными пользователя следующего вида:
```json
{"user": {
    "email": "str",
    "first_name": "str",
    "last_name": "str",
    "username": "str",
    "password": "str"
}}
```
### ВНИМАНИЕ!!! 
- Создание опросов (включая вопросы и ответы на них), их изменение и деактивация доступна 
- Отвечать на опросы могут:
   - Авторизованные пользователи 
   - НЕ авторизованные пользователи (в этом случае headers должен отсутствовать 
   и будет автоматически подставлен пользователь anonymous)
- Получить данные о пройденных опросах могут ТОЛЬКО авторизованные пользователи, 
   которые отвечали на вопросы АВТОРИЗОВАННЫМИ.

___
### Опросы, вопросы и варианты ответов:
#### Создание опроса:
Ссылка: ```/api/polls/create/```
Метод: ```post```
На вход принимает json вида:
```json
{"polls": {
    "name": "str",
    "description": "str",
    "start_date": "date(yyyy-mm-dd)",
    "end_date": "date(yyyy-mm-dd)"
}}
```
При успешном создании опроса вернется статус 201_CREATED и json с созданным опросом следующего вида:
```json
{"polls": {
    "id": "int",
    "name": "str",
    "description": "str",
    "start_date": "date(yyyy-mm-dd)",
    "end_date": "date(yyyy-mm-dd)",
    "is_active": "bool"
}}
```
#### Изменение опроса:
Ссылка: ```/api/polls/create/```
Метод: ```patch```
На вход принимает json вида:
```json
{"polls": {
    "id": "int", 
    "name": "str",
    "description": "str",
    "end_date": "date(yyyy-mm-dd)",
    "is_active": "bool"
}}
```
Возможно частичное изменение значений полей, передавать ВСЕ данные для изменения одного поля не нужно.
При успешном выполнении запроса вернется статус 200_OK и json с измененными данными.

### ВНИМАНИЕ!!!!
- Изменение Даты старта опроса после создания опроса НЕВОЗМОЖНО.
- Изменение АКТИВНОСТИ опроса влечет за собой изменение активности ВОПРОСОВ,
   относящихся к этому ОПРОСУ и ОТВЕТОВ на ВОПРОСЫ, относящихся к соответствующим ВОПРОСАМ. 

#### Получение списка ВСЕХ опросов:
Ссылка: ```/api/polls/list/```
Метод: ```get```
При успешном выполнении запроса вернется статус 200_OK и json со всеми опросами следующего вида:
```json
{"polls":[{
    "id": "int",
    "name": "str",
    "description": "str",
    "start_date": "date(yyyy-mm-dd)",
    "end_date": "date(yyyy-mm-dd)",
    "is_active": "bool"}]
}
```
#### Получение списка активных опросов:
Ссылка: ```/api/polls/getOnePollOrActiveList/```
Метод: ```get```
*__Доступно для ВСЕХ пользователей.__*
При успешном выполнении запроса вернется статус 200_OK и json со всеми АКТИВНЫМИ опросами следующего вида:
```json
{"polls":[{
    "id": "int",
    "name": "str",
    "description": "str",
    "start_date": "date(yyyy-mm-dd)",
    "end_date": "date(yyyy-mm-dd)",
    "is_active": "bool"}]
}

```
#### Получение конкретного АКТИВНОГО опроса:
Ссылка: ```/api/polls/getOnePollOrActiveList/```
Метод: ```get```
*__Доступно для ВСЕХ пользователей.__*
На вход принимает json вида:
```json
{"polls": 
    {"id": "int"}
}
```
В случае попытки получить неактивный опрос вернется статус 204_NO_CONTENT.
При успешном выполнении запроса вернется статус 200_OK и json вида:
```json
{"poll": 
    {
      "id": "int",
      "name": "str",
      "description": "str",
      "start_date": "date(yyyy-mm-dd)",
      "end_date": "date(yyyy-mm-dd)",
      "is_active": "bool"
    },
    "questions": 
    [
      {
        "question": {
          "id": "int",
          "question_type": "str (choices)",
          "question_text": "str",
          "is_active": "bool",
          "poll_id": "int"
        },
        "question_options": [{
            "id": "int",
            "question_answer": "str",
            "is_active": "bool",
            "question_id": "int"}]
      }
    ]
}
```
json содержит информацию о конкретном опросе и в "questions" содержит пары: вопрос и ответы на вопрос(при наличии),
относящиеся к этому опросу
#### Создание вопроса:
Ссылка: ```/api/questions/create/```
Метод: ```post```
На вход принимает json вида:
```json
{"question": {
    "poll_id": "int",
    "question_type": "str (choices)",
    "question_text": "str"
     },
"question_options": ["str", "str", "str"]
}
```
При успешном выполнении запроса вернется статус HTTP_201_CREATED и json вида:
```json
{"question": "Вопрос создан", "question_options": "Варианты ответов добавлены"}
```
### ВНИМАНИЕ!!!!
- Поле question_type может иметь 3 значения:
    - MANY_ANSWERS - Означает, что на вопрос может быть несколько ответов, выбранных пользователем из списка.
    - ONE_ANSWER - Означает, что на вопрос должен быть один ответ, выбранный пользователем из списка.
    - TEXT_ANSWER - Означает, что на вопрос должен быть ТЕКСТОВЫЙ ответ от пользователя

#### Обновление вопроса:
Ссылка: ```/api/questions/update/```
Метод: ```patch```
На вход принимает json вида:
```json
{"question": {
    "id": "int",
    "poll_id": "int",
    "question_type": "str (CHOICE)",
    "question_text": "str",
    "is_active": "bool"
}}
```
Возможно частичное изменение значений полей, передавать ВСЕ данные для изменения одного поля не нужно.
При успешном выполнении запроса вернется статус 200_OK и json с измененными данными.

### ВНИМАНИЕ!!!!
- Изменение АКТИВНОСТИ Вопроса влечет за собой изменение активности ответов,
   относящихся к этому ВОПРОСУ. 

#### Создание варианта ответа на определенный вопрос
Ссылка: ```api/questionOptions/create/```
Метод: ```post```
На вход принимает json вида:
```json
{"question_options": [
         {"question_id": "int", 
           "question_answer": "str"}
      ]
}
```
Список может содержать неограниченное количество вариантов ответа 
(возможно добавление вариантов ответа по РАЗНЫМ вопросам).
При успешном выполнении запроса вернется статус 200_OK и json вида:
```json
{"question_options": "Варианты ответов добавлены"}
```
#### Изменение варианта ответа на определенный вопрос
Ссылка: ```api/questionOptions/update/```
Метод: ```patch```
На вход принимает json вида:
```json
{
"question_options": [
        {"id": "int", 
         "question_id": "int",
         "question_answer": "str"}
    ]
}
```
Список может содержать неограниченное количество вариантов ответа 
(возможно изменение вариантов ответа по РАЗНЫМ вопросам).
При успешном выполнении запроса вернется статус 200_OK и json вида:
{'question_options': 'Варианты ответов изменены'}

### Ответ пользователя на опрос, запрос информации о пройденных опросах:
#### Ответ пользователя на опрос:

Ссылка: ```api/users/answersCreate/```
Метод: ```post```
*__Доступно для ВСЕХ пользователей.__*
На вход принимает json вида:
```json
{"answers": {
        "poll_id": "int",
        "question_id": "int",
        "question_option_id": ["int", "int", "int"],
        "user_answer": "str"}
}
```
Подразумевается, что пользователь будет проходить опрос передавая ответы на вопросы последовательно.
При успешном выполнении запроса вернется статус 200_OK и json вида:
```json
{"answers": "Данные сохранены."}
```


#### Запрос информации о пройденных опросах:
Ссылка: ```api/users/answersList/```
Метод: ```get```
Доступно ТОЛЬКО АВТОРИЗОВАННОМУ пользователю. 
При попытке получить данные без авторизации вернется статус 403_FORBIDDEN и json вида:
```json
{"error": "Пользователь не авторизован"}
```
При успешном выполнении запроса вернется статус 200_OK и json вида:
```json
{"polls": [
  {"poll":
    {"id": 1,
     "name": "Опрос номер 1",
     "description": "Описание опроса номер 1",
     "start_date": "2021-07-08",
     "end_date": "2021-07-10", 
     "is_active": "True"
    },
     "questions": [
       {"question": {"id": 1,
         "question_type": "TEXT_ANSWER",
         "question_text": "Вопрос 1 опроса 1 с текстовым ответом",
         "is_active": "True", "poll_id": 1},
       "answers": [
         "Либо текст либо dict с ответом"]
       }]
  }
  
]}
```
json содержит информацию по пройденным пользователем опросам с вопросами и ответом пользователя на него.

## Таблица API с с методами и описаниями:
| URL  | Метод | Описание|
|----:|:----:|:----:|
| api/users/login/ | post | Авторизация пользователя
| api/users/register/ | post | Регистрация пользователя
| api/users/update/ | patch | Обновление данных пользователя
| api/users/user/ | get | Получение данных о пользователе
| api/users/answersCreate/ | post | Отправка ответа пользователя на вопрос опроса
| api/users/answersList/ | get | Получение пройденных опросов пользователя
| api/polls/create/ | post | Создание опроса
| api/polls/update/ | patch | Изменение опроса
| api/polls/list/ | get | Получение списка ВСЕХ опросов
| api/polls/getOnePollOrActiveList/ | get | Получение конкретного опроса, либо списка АКТИВНЫХ опросов |Есть|
| api/questions/create/ | post | Создание вопроса пользователя
| api/questions/update/ | patch | Обновление данных вопроса
| api/questionOptions/create/ | post | Создание вариантов ответа на определенный вопрос
| api/questionOptions/update/ | patch | Обновление данных варианта ответа на вопрос
